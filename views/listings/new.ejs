<% layout("/layouts/boilerplate") %>

<main class="max-w-4xl mx-auto px-6 md:px-12 py-20">
  <!-- Header -->
  <header class="mb-16 text-center">
    <h1 class="text-5xl md:text-6xl font-serif font-bold text-stone-900 dark:text-stone-50 mb-4">List Your Property</h1>
    <p class="text-lg text-stone-600 dark:text-stone-400 font-light">Share your space with travelers from around the world</p>
  </header>

  <!-- Form -->
  <form method="post" action="/listings" novalidate class="needs-validation space-y-16" enctype="multipart/form-data">
    <!-- Basic Information Section -->
    <section>
      <h2 class="text-2xl font-serif font-bold text-stone-900 dark:text-stone-50 mb-8 pb-4 border-b border-stone-200 dark:border-stone-700">Basic Information</h2>

      <!-- Title -->
      <div class="mb-8">
        <label for="title" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3 block">Property Title</label>
        <input type="text" name="listing[title]" id="title" placeholder="e.g., Cozy Beachfront Villa with Ocean View" class="bg-transparent border-0 border-b border-stone-300 dark:border-stone-600 px-0 py-2 focus:ring-0 w-full text-lg font-light text-stone-900 dark:text-stone-50 transition-colors" required />
        <small class="text-xs text-stone-500 dark:text-stone-400 mt-2 block">Make it descriptive and appealing</small>
        <div class="invalid-feedback text-xs text-red-600 dark:text-red-400 mt-1">Please enter a property title.</div>
      </div>

      <!-- Description -->
      <div class="mb-8">
        <label for="description" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3 block">Description</label>
        <textarea name="listing[description]" id="description" placeholder="Describe your property, amenities, location highlights, and what guests should know..." class="bg-transparent border-0 border-b border-stone-300 dark:border-stone-600 px-0 py-2 focus:ring-0 w-full text-lg font-light text-stone-900 dark:text-stone-50 resize-none transition-colors" rows="5" required></textarea>
        <small class="text-xs text-stone-500 dark:text-stone-400 mt-2 block">Be detailed - good descriptions attract more bookings</small>
        <div class="invalid-feedback text-xs text-red-600 dark:text-red-400 mt-1">Please enter a property description.</div>
      </div>

      <!-- Image Upload -->
      <div class="mb-8">
        <label for="image" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3 block">Property Photo</label>
        <div class="image-upload-wrapper">
          <input type="file" name="listing[image]" id="imageInput" class="hidden" accept="image/jpeg,image/png,image/webp,image/jpg" required>
          <div class="upload-area border-2 border-dashed border-stone-300 dark:border-stone-600 rounded-lg p-8 text-center cursor-pointer bg-stone-50 dark:bg-stone-800 transition-all" onclick="document.getElementById('imageInput').click()" style="min-height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div class="text-4xl mb-4 text-stone-400 dark:text-stone-500">ðŸ“·</div>
            <p class="font-semibold text-stone-900 dark:text-stone-50 mb-1">Click to upload or drag and drop</p>
            <small class="text-sm text-stone-500 dark:text-stone-400">JPG, PNG, WebP up to 50MB</small>
          </div>
          <div class="image-preview-wrapper mt-4" style="display: none;">
            <img id="imagePreview" style="max-width: 100%; height: 250px; object-fit: cover; border-radius: 8px; border: 1px solid #e7e5e4;">
            <button type="button" class="w-full mt-4 px-6 py-2 text-xs uppercase tracking-widest font-bold border border-red-600 text-red-600 dark:border-red-400 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors" onclick="clearImageUpload()">
              Remove Image
            </button>
          </div>
        </div>
        <div class="invalid-feedback text-xs text-red-600 dark:text-red-400 mt-2 block">Please upload a property image.</div>
      </div>
    </section>

    <!-- Location & Pricing Section -->
    <section>
      <h2 class="text-2xl font-serif font-bold text-stone-900 dark:text-stone-50 mb-8 pb-4 border-b border-stone-200 dark:border-stone-700">Location & Pricing</h2>

      <div class="grid md:grid-cols-2 gap-8 mb-8">
        <!-- City/Location -->
        <div class="flex flex-col">
          <label for="location" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3">City/Location</label>
          <input type="text" name="listing[location]" id="location" placeholder="e.g., Mumbai, Maharashtra" class="bg-transparent border-0 border-b border-stone-300 dark:border-stone-600 px-0 py-2 focus:ring-0 text-lg font-light text-stone-900 dark:text-stone-50 transition-colors" required />
          <div class="invalid-feedback text-xs text-red-600 dark:text-red-400 mt-1">Please enter a location.</div>
        </div>
        <!-- Country -->
        <div class="flex flex-col">
          <label for="country" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3">Country</label>
          <input type="text" name="listing[country]" id="country" placeholder="e.g., India" class="bg-transparent border-0 border-b border-stone-300 dark:border-stone-600 px-0 py-2 focus:ring-0 text-lg font-light text-stone-900 dark:text-stone-50 transition-colors" required />
          <div class="invalid-feedback text-xs text-red-600 dark:text-red-400 mt-1">Please enter a country.</div>
        </div>
      </div>

      <!-- Listing Type & Price -->
      <div class="grid md:grid-cols-2 gap-8 mb-8">
        <div class="flex flex-col">
          <label for="listingType" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3">Listing Type</label>
          <select name="listing[listingType]" id="listingType" class="bg-transparent border-0 border-b border-stone-300 dark:border-stone-600 px-0 py-2 focus:ring-0 text-lg font-light text-stone-900 dark:text-stone-50 transition-colors" required>
            <option value="For Rent">For Rent</option>
            <option value="For Sale">For Sale</option>
          </select>
          <div class="invalid-feedback text-xs text-red-600 dark:text-red-400 mt-1">Please select a listing type.</div>
        </div>
        <div class="flex flex-col">
          <label for="price" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3"><span id="priceLabel">Price Per Night</span></label>
          <div class="relative flex items-center">
            <span class="absolute left-0 text-lg font-light text-stone-600 dark:text-stone-400">â‚¹</span>
            <input type="number" name="listing[price]" id="price" placeholder="5000" class="bg-transparent border-0 border-b border-stone-300 dark:border-stone-600 px-0 py-2 pl-8 focus:ring-0 w-full text-lg font-light text-stone-900 dark:text-stone-50 transition-colors" required />
          </div>
          <small class="text-xs text-stone-500 dark:text-stone-400 mt-2 block" id="priceHint">This is what guests will pay per night</small>
          <div class="invalid-feedback text-xs text-red-600 dark:text-red-400 mt-1">Please enter a valid price.</div>
        </div>
      </div>

      <script>
        // Update price label and hint based on listing type
        const listingTypeSelect = document.getElementById('listingType');
        const priceLabel = document.getElementById('priceLabel');
        const priceHint = document.getElementById('priceHint');
        const priceInput = document.getElementById('price');
        
        listingTypeSelect.addEventListener('change', function() {
          if (this.value === 'For Rent') {
            priceLabel.textContent = 'Price Per Night';
            priceHint.textContent = 'This is what guests will pay per night';
            priceInput.placeholder = '5000';
          } else {
            priceLabel.textContent = 'Sale Price';
            priceHint.textContent = 'The total sale price for this property';
            priceInput.placeholder = '500000';
          }
        });
      </script>

      <!-- Map Section -->
      <div class="mb-8">
        <label class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3 block">Set Location on Map</label>
        <small class="text-sm text-stone-500 dark:text-stone-400 mb-3 block">Click on the map to pin your exact location</small>
        <% if (googleMapsApiKey) { %>
          <div id="map" style="width: 100%; height: 400px; border-radius: 8px; overflow: hidden; border: 1px solid #e7e5e4;" class="dark:border-stone-700" data-lat="" data-lng=""></div>
        <% } else { %>
          <div class="border border-yellow-200 dark:border-yellow-800 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4">
            <p class="text-sm text-yellow-800 dark:text-yellow-200"><strong>Google Maps API Key Not Configured</strong><br>The map feature requires a Google Maps API key. Please add <code>GOOGLE_MAPS_API_KEY</code> to your <code>.env</code> file.</p>
          </div>
        <% } %>
      </div>

      <!-- Coordinates -->
      <div class="grid md:grid-cols-2 gap-8">
        <div class="flex flex-col">
          <label for="latitude" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3">Latitude</label>
          <input type="number" step="0.000001" id="latitude" name="listing[latitude]" placeholder="Auto-filled when pin on map" class="bg-transparent border-0 border-b border-stone-300 dark:border-stone-600 px-0 py-2 focus:ring-0 text-lg font-light text-stone-900 dark:text-stone-50 transition-colors" />
        </div>
        <div class="flex flex-col">
          <label for="longitude" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3">Longitude</label>
          <input type="number" step="0.000001" id="longitude" name="listing[longitude]" placeholder="Auto-filled when pin on map" class="bg-transparent border-0 border-b border-stone-300 dark:border-stone-600 px-0 py-2 focus:ring-0 text-lg font-light text-stone-900 dark:text-stone-50 transition-colors" />
        </div>
      </div>
    </section>

    <!-- Property Details Section -->
    <section>
      <h2 class="text-2xl font-serif font-bold text-stone-900 dark:text-stone-50 mb-8 pb-4 border-b border-stone-200 dark:border-stone-700">Property Details</h2>

      <!-- Bedrooms, Beds, Bathrooms -->
      <div class="grid md:grid-cols-3 gap-8 mb-8">
        <div class="flex flex-col">
          <label for="bedrooms" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3">Bedrooms</label>
          <input type="number" name="listing[bedrooms]" id="bedrooms" min="0" value="1" class="bg-transparent border-0 border-b border-stone-300 dark:border-stone-600 px-0 py-2 focus:ring-0 text-lg font-light text-stone-900 dark:text-stone-50 transition-colors" />
        </div>
        <div class="flex flex-col">
          <label for="beds" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3">Beds</label>
          <input type="number" name="listing[beds]" id="beds" min="1" value="1" class="bg-transparent border-0 border-b border-stone-300 dark:border-stone-600 px-0 py-2 focus:ring-0 text-lg font-light text-stone-900 dark:text-stone-50 transition-colors" />
        </div>
        <div class="flex flex-col">
          <label for="bathrooms" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3">Bathrooms</label>
          <input type="number" name="listing[bathrooms]" id="bathrooms" min="0" step="0.5" value="1" class="bg-transparent border-0 border-b border-stone-300 dark:border-stone-600 px-0 py-2 focus:ring-0 text-lg font-light text-stone-900 dark:text-stone-50 transition-colors" />
        </div>
      </div>

      <!-- Property Type & Max Guests -->
      <div class="grid md:grid-cols-2 gap-8 mb-8">
        <div class="flex flex-col">
          <label for="propertyType" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3">Property Type</label>
          <select name="listing[propertyType]" id="propertyType" class="bg-transparent border-0 border-b border-stone-300 dark:border-stone-600 px-0 py-2 focus:ring-0 text-lg font-light text-stone-900 dark:text-stone-50 transition-colors">
            <option value="Apartment">Apartment</option>
            <option value="House">House</option>
            <option value="Villa">Villa</option>
            <option value="Cabin">Cabin</option>
            <option value="Condo">Condo</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="flex flex-col">
          <label for="maxGuests" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3">Max Guests</label>
          <input type="number" name="listing[maxGuests]" id="maxGuests" min="1" value="2" class="bg-transparent border-0 border-b border-stone-300 dark:border-stone-600 px-0 py-2 focus:ring-0 text-lg font-light text-stone-900 dark:text-stone-50 transition-colors" />
        </div>
      </div>

      <!-- Square Feet -->
      <div class="mb-8">
        <label for="squareFeet" class="text-xs uppercase tracking-widest font-bold text-stone-600 dark:text-stone-400 mb-3 block">Square Feet (Optional)</label>
        <input type="number" name="listing[squareFeet]" id="squareFeet" placeholder="e.g., 1500" class="bg-transparent border-0 border-b border-stone-300 dark:border-stone-600 px-0 py-2 focus:ring-0 w-full text-lg font-light text-stone-900 dark:text-stone-50 transition-colors" />
      </div>
    </section>

    <!-- Amenities Section -->
    <section>
      <h2 class="text-2xl font-serif font-bold text-stone-900 dark:text-stone-50 mb-8 pb-4 border-b border-stone-200 dark:border-stone-700">Amenities</h2>

      <div class="grid md:grid-cols-3 gap-8">
        <!-- Column 1 -->
        <div class="space-y-4">
          <label class="flex items-center gap-3 cursor-pointer group">
            <input class="w-5 h-5 border border-stone-300 dark:border-stone-600 rounded accent-primary" type="checkbox" name="listing[amenities]" value="Wifi" id="wifi">
            <span class="font-semibold text-stone-900 dark:text-stone-50 group-hover:text-primary transition-colors">Wifi</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer group">
            <input class="w-5 h-5 border border-stone-300 dark:border-stone-600 rounded accent-primary" type="checkbox" name="listing[amenities]" value="Kitchen" id="kitchen">
            <span class="font-semibold text-stone-900 dark:text-stone-50 group-hover:text-primary transition-colors">Kitchen</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer group">
            <input class="w-5 h-5 border border-stone-300 dark:border-stone-600 rounded accent-primary" type="checkbox" name="listing[amenities]" value="TV" id="tv">
            <span class="font-semibold text-stone-900 dark:text-stone-50 group-hover:text-primary transition-colors">TV</span>
          </label>
        </div>
        <!-- Column 2 -->
        <div class="space-y-4">
          <label class="flex items-center gap-3 cursor-pointer group">
            <input class="w-5 h-5 border border-stone-300 dark:border-stone-600 rounded accent-primary" type="checkbox" name="listing[amenities]" value="Air Conditioning" id="ac">
            <span class="font-semibold text-stone-900 dark:text-stone-50 group-hover:text-primary transition-colors">Air Conditioning</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer group">
            <input class="w-5 h-5 border border-stone-300 dark:border-stone-600 rounded accent-primary" type="checkbox" name="listing[amenities]" value="Parking" id="parking">
            <span class="font-semibold text-stone-900 dark:text-stone-50 group-hover:text-primary transition-colors">Parking</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer group">
            <input class="w-5 h-5 border border-stone-300 dark:border-stone-600 rounded accent-primary" type="checkbox" name="listing[amenities]" value="Pool" id="pool">
            <span class="font-semibold text-stone-900 dark:text-stone-50 group-hover:text-primary transition-colors">Pool</span>
          </label>
        </div>
        <!-- Column 3 -->
        <div class="space-y-4">
          <label class="flex items-center gap-3 cursor-pointer group">
            <input class="w-5 h-5 border border-stone-300 dark:border-stone-600 rounded accent-primary" type="checkbox" name="listing[amenities]" value="Washer" id="washer">
            <span class="font-semibold text-stone-900 dark:text-stone-50 group-hover:text-primary transition-colors">Washer</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer group">
            <input class="w-5 h-5 border border-stone-300 dark:border-stone-600 rounded accent-primary" type="checkbox" name="listing[amenities]" value="Gym" id="gym">
            <span class="font-semibold text-stone-900 dark:text-stone-50 group-hover:text-primary transition-colors">Gym</span>
          </label>
          <label class="flex items-center gap-3 cursor-pointer group">
            <input class="w-5 h-5 border border-stone-300 dark:border-stone-600 rounded accent-primary" type="checkbox" name="listing[amenities]" value="Workspace" id="workspace">
            <span class="font-semibold text-stone-900 dark:text-stone-50 group-hover:text-primary transition-colors">Workspace</span>
          </label>
        </div>
      </div>
    </section>

    <!-- Action Buttons -->
    <div class="pt-8 border-t border-stone-200 dark:border-stone-700 flex gap-4 justify-end">
      <a href="/listings" class="px-8 py-3 text-xs uppercase tracking-widest font-bold border border-stone-300 dark:border-stone-600 text-stone-900 dark:text-stone-50 hover:bg-stone-100 dark:hover:bg-stone-800 transition-colors">
        Cancel
      </a>
      <button type="submit" class="px-8 py-3 text-xs uppercase tracking-widest font-bold bg-stone-900 dark:bg-stone-50 text-stone-50 dark:text-stone-900 hover:bg-black dark:hover:bg-white transition-colors">
        Publish Property
      </button>
    </div>
  </form>
</main>

<style>
  input:focus, textarea:focus, select:focus {
    outline: none !important;
    box-shadow: none !important;
    border-color: #0F172A !important;
  }
  
  .dark input:focus,
  .dark textarea:focus,
  .dark select:focus {
    border-color: #f8f8f7 !important;
  }

  .cursor-pointer {
    cursor: pointer;
  }

  #imageInput {
    display: none;
  }

  input[type="checkbox"]:focus {
    outline: none !important;
  }

  .invalid-feedback {
    display: none;
  }

  .was-validated input:invalid ~ .invalid-feedback,
  .was-validated textarea:invalid ~ .invalid-feedback,
  .was-validated select:invalid ~ .invalid-feedback {
    display: block;
  }

  .was-validated input:invalid,
  .was-validated textarea:invalid,
  .was-validated select:invalid {
    border-color: #dc2626;
  }
</style>

<script>
  // Form validation
  (function() {
    'use strict';
    
    const forms = document.querySelectorAll('.needs-validation');
    
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', function(event) {
        // Check if file was selected
        const fileInput = form.querySelector('input[name="listing[image]"]');
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
          event.preventDefault();
          event.stopPropagation();
          alert('Please upload a property image');
          return false;
        }
        
        // Ensure price is a number
        const priceInput = form.querySelector('input[name="listing[price]"]');
        if (priceInput && priceInput.value) {
          priceInput.value = parseFloat(priceInput.value);
        }
        
        // Ensure numeric fields
        const numericFields = ['bedrooms', 'beds', 'bathrooms', 'maxGuests', 'squareFeet'];
        numericFields.forEach(field => {
          const input = form.querySelector(`input[name="listing[${field}]"]`);
          if (input && input.value) {
            input.value = field === 'bathrooms' ? parseFloat(input.value) : parseInt(input.value);
          }
        });
        
        // Ensure coordinates are floats
        const latInput = form.querySelector('input[name="listing[latitude]"]');
        const lngInput = form.querySelector('input[name="listing[longitude]"]');
        if (latInput && latInput.value) {
          latInput.value = parseFloat(latInput.value);
        }
        if (lngInput && lngInput.value) {
          lngInput.value = parseFloat(lngInput.value);
        }
        
        // Bootstrap validation
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        
        form.classList.add('was-validated');
      }, false);
    });
  })();
  
  // Function to clear image upload
  function clearImageUpload() {
    const fileInput = document.getElementById('imageInput');
    const uploadArea = document.querySelector('.upload-area');
    const previewWrapper = document.querySelector('.image-preview-wrapper');
    
    fileInput.value = '';
    uploadArea.style.display = 'flex';
    previewWrapper.style.display = 'none';
  }
  
  // File upload with preview and drag-and-drop
  const fileInput = document.getElementById('imageInput');
  const uploadArea = document.querySelector('.upload-area');
  const previewWrapper = document.querySelector('.image-preview-wrapper');
  const imagePreview = document.getElementById('imagePreview');
  
  if (fileInput && uploadArea) {
    // Click to upload
    fileInput.addEventListener('change', handleFileSelect);
    
    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.add('border-stone-400', 'dark:border-stone-400', 'bg-stone-100', 'dark:bg-stone-700');
    });
    
    uploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.remove('border-stone-400', 'dark:border-stone-400', 'bg-stone-100', 'dark:bg-stone-700');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.remove('border-stone-400', 'dark:border-stone-400', 'bg-stone-100', 'dark:bg-stone-700');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect({ target: fileInput });
      }
    });
  }
  
  function handleFileSelect(e) {
    const file = e.target.files[0];
    
    if (file) {
      // Validate file type
      const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/jpg'];
      if (!validTypes.includes(file.type)) {
        alert('Please upload a valid image file (JPG, PNG, or WebP)');
        fileInput.value = '';
        return;
      }
      
      // Validate file size (max 50MB)
      const maxSize = 50 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('File size exceeds 50MB. Please upload a smaller file.');
        fileInput.value = '';
        return;
      }
      
      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        imagePreview.src = e.target.result;
        uploadArea.style.display = 'none';
        previewWrapper.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  }
</script>
