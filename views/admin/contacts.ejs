<% layout("/layouts/boilerplate") %>

<div class="container mt-5">
  <div class="row">
    <div class="col-md-12">
      <h1 class="mb-4">Contact Messages</h1>

      <% if(contacts.length === 0) { %>
        <div class="alert alert-info">No messages yet</div>
      <% } else { %>
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Subject</th>
                <th>Date</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <% contacts.forEach(contact => { %>
                <tr>
                  <td><%= contact.name %></td>
                  <td><%= contact.email %></td>
                  <td><%= contact.subject %></td>
                  <td><%= contact.createdAt.toLocaleDateString() %></td>
                  <td>
                    <% if(contact.status === 'new') { %>
                      <span class="badge bg-success">New</span>
                    <% } else if(contact.status === 'read') { %>
                      <span class="badge bg-warning">Read</span>
                    <% } else { %>
                      <span class="badge bg-info">Responded</span>
                    <% } %>
                  </td>
                  <td>
                    <a href="#" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#viewModal<%= contact._id %>">View</a>
                  </td>
                </tr>

                <!-- Modal for viewing full message -->
                <div class="modal fade" id="viewModal<%= contact._id %>" tabindex="-1">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Message from <%= contact.name %></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <p><strong>Name:</strong> <%= contact.name %></p>
                        <p><strong>Email:</strong> <%= contact.email %></p>
                        <% if(contact.phone) { %>
                          <p><strong>Phone:</strong> <%= contact.phone %></p>
                        <% } %>
                        <p><strong>Subject:</strong> <%= contact.subject %></p>
                        <p><strong>User Type:</strong> <%= contact.userType %></p>
                        <p><strong>Date:</strong> <%= contact.createdAt.toLocaleString() %></p>

                        <hr />

                        <h6>Message:</h6>
                        <p class="border-start border-4 ps-3"><%= contact.message %></p>

                        <% if(contact.status === 'responded' && contact.response) { %>
                          <hr />
                          <h6>Your Response:</h6>
                          <p class="border-start border-4 ps-3 bg-light p-3"><%= contact.response %></p>
                          <p><small>Responded on: <%= contact.respondedAt.toLocaleString() %></small></p>
                        <% } %>
                      </div>
                      <div class="modal-footer">
                        <% if(contact.status !== 'responded') { %>
                          <form action="/admin/contacts/<%= contact._id %>/respond" method="POST" class="w-100">
                            <textarea name="response" class="form-control mb-2" placeholder="Your response..." rows="3" required></textarea>
                            <button type="submit" class="btn btn-success">Send Response</button>
                          </form>
                        <% } %>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </div>
</div>

<style>
  body {
    background-color: #f5f5f5;
  }

  .container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-top: 30px;
    margin-bottom: 30px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  h1 {
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
  }

  .table {
    margin-bottom: 0;
  }

  .badge {
    font-size: 0.9rem;
  }
</style>
